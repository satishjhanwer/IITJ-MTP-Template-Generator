name: Compile LaTeX to PDF

on:
  push:
    branches: [main, master]
    paths:
      - "output/**/*.tex"
  workflow_dispatch:
    inputs:
      report_path:
        description: "Path to report directory (e.g., output/my-project)"
        required: false
        default: "output"

jobs:
  compile-latex:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install LaTeX
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-latex-base texlive-latex-extra texlive-bibtex-extra biber

      - name: Find and compile LaTeX files
        run: |
          # Function to compile a LaTeX file
          compile_latex() {
            local tex_file="$1"
            local dir=$(dirname "$tex_file")
            local base=$(basename "$tex_file" .tex)
            
            echo "üìù Compiling: $tex_file"
            cd "$dir"
            
            # First pass
            pdflatex -interaction=nonstopmode "$base.tex" || echo "‚ö†Ô∏è First pass had warnings"
            
            # Run bibtex if .bib file exists
            if ls *.bib 1> /dev/null 2>&1; then
              bibtex "$base" || echo "‚ö†Ô∏è BibTeX had warnings"
            fi
            
            # Second pass
            pdflatex -interaction=nonstopmode "$base.tex" || echo "‚ö†Ô∏è Second pass had warnings"
            
            # Third pass for references
            pdflatex -interaction=nonstopmode "$base.tex" || echo "‚ö†Ô∏è Third pass had warnings"
            
            if [ -f "$base.pdf" ]; then
              echo "‚úÖ Successfully compiled: $base.pdf"
            else
              echo "‚ùå Failed to compile: $tex_file"
            fi
            
            cd - > /dev/null
          }

          # Find all main LaTeX files (proposal.tex, main.tex, slides.tex)
          echo "üîç Searching for LaTeX files in output directory..."

          # Compile proposal reports
          find output -name "proposal.tex" -type f | while read file; do
            compile_latex "$file"
          done

          # Compile major project reports
          find output -name "main.tex" -type f | while read file; do
            compile_latex "$file"
          done

          # Compile presentation slides
          find output -name "slides.tex" -type f | while read file; do
            compile_latex "$file"
          done

      - name: List compiled PDFs
        run: |
          echo "üìÑ Compiled PDF files:"
          find output -name "*.pdf" -type f || echo "No PDFs found"

      - name: Upload PDF artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: compiled-pdfs-${{ github.run_number }}
          path: output/**/*.pdf
          retention-days: 30
          if-no-files-found: warn

      - name: Compilation Summary
        if: always()
        run: |
          echo "üìä Compilation Summary"
          echo "====================="
          pdf_count=$(find output -name "*.pdf" -type f | wc -l)
          echo "Total PDFs generated: $pdf_count"

          if [ $pdf_count -gt 0 ]; then
            echo "‚úÖ Compilation successful!"
            echo ""
            echo "üì• Download artifacts from the Actions tab:"
            echo "   https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            echo "‚ö†Ô∏è No PDFs were generated. Check the logs above for errors."
          fi
